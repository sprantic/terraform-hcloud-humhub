#!/bin/bash
# HumHub installation script
# Generated by Terraform/Ansible

set -e

HUMHUB_DIR="/var/www/humhub"
DB_HOST="{{ db_host }}"
DB_NAME="humhub"
DB_USER="humhub"
DB_PASS="{{ db_password }}"
ADMIN_EMAIL="{{ humhub_admin_email }}"
ADMIN_USERNAME="{{ humhub_admin_username }}"
ADMIN_PASSWORD="{{ humhub_admin_password }}"

echo "Starting HumHub installation..."

# Wait for database to be ready
echo "Waiting for database connection..."
while ! mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -e "SELECT 1" >/dev/null 2>&1; do
    echo "Waiting for database..."
    sleep 5
done

echo "Database connection established"

# Change to HumHub directory
cd "$HUMHUB_DIR"

# Set proper ownership
chown -R www-data:www-data "$HUMHUB_DIR"

# Install HumHub via console command
echo "Installing HumHub..."
sudo -u www-data php yii installer/install-db \
    --db_hostname="$DB_HOST" \
    --db_database="$DB_NAME" \
    --db_username="$DB_USER" \
    --db_password="$DB_PASS"

# Create admin user
echo "Creating admin user..."
sudo -u www-data php yii installer/create-admin-user \
    --username="$ADMIN_USERNAME" \
    --email="$ADMIN_EMAIL" \
    --password="$ADMIN_PASSWORD"

# Set application settings
echo "Configuring HumHub settings..."
sudo -u www-data php yii installer/set-base-url \
{% if domain_name %}
    --baseUrl="{{ "https" if enable_ssl else "http" }}://{{ domain_name }}"
{% else %}
    --baseUrl="http://$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)"
{% endif %}

# Enable caching
sudo -u www-data php yii installer/enable-cache

# Set timezone
sudo -u www-data php yii installer/set-timezone --timezone="UTC"

# Install default modules
echo "Installing default modules..."
sudo -u www-data php yii module/enable activity
sudo -u www-data php yii module/enable admin
sudo -u www-data php yii module/enable comment
sudo -u www-data php yii module/enable content
sudo -u www-data php yii module/enable dashboard
sudo -u www-data php yii module/enable directory
sudo -u www-data php yii module/enable file
sudo -u www-data php yii module/enable friendship
sudo -u www-data php yii module/enable like
sudo -u www-data php yii module/enable live
sudo -u www-data php yii module/enable notification
sudo -u www-data php yii module/enable post
sudo -u www-data php yii module/enable search
sudo -u www-data php yii module/enable space
sudo -u www-data php yii module/enable stream
sudo -u www-data php yii module/enable tour
sudo -u www-data php yii module/enable user

{% if keycloak_integration | default(false) %}
# Prepare for Keycloak integration
echo "Preparing Keycloak integration..."
# Note: The actual Keycloak module needs to be installed manually
# This just prepares the configuration
{% endif %}

# Final ownership and permissions
chown -R www-data:www-data "$HUMHUB_DIR"
find "$HUMHUB_DIR" -type d -exec chmod 755 {} \;
find "$HUMHUB_DIR" -type f -exec chmod 644 {} \;
chmod -R 777 "$HUMHUB_DIR/protected/runtime"
chmod -R 777 "$HUMHUB_DIR/uploads"
chmod -R 777 "$HUMHUB_DIR/assets"

echo "HumHub installation completed successfully!"
echo "Admin user: $ADMIN_USERNAME"
echo "Admin email: $ADMIN_EMAIL"
{% if domain_name %}
echo "Access URL: {{ "https" if enable_ssl else "http" }}://{{ domain_name }}"
{% else %}
echo "Access URL: http://$(curl -s http://169.254.169.254/metadata/v1/interfaces/public/0/ipv4/address)"
{% endif %}